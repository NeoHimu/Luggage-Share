{% load static %}

{% if submitted_tickets %}
<div class="container">
  <ul class="nav nav-tabs nav-justified">
  	<li><a style="font-size:16px;" data-toggle="tab" href="#id-cab-to-ariport-tab">Cab to Airport...</a></li>
    <li style="font-size:16px;" class="active"><a data-toggle="tab" href="#id-baggage-share-tab">Share baggage...</a></li>
    <li><a style="font-size:16px;" data-toggle="tab" href="#id-cab-from-airport-tab">Cab from Airport</a></li>
  </ul>

  <div class="tab-content">
  	<div id="id-cab-to-ariport-tab" class="tab-pane fade">
  		    <section>
		        <div id='map-canvas-departure' style="z-index: 1"></div>
		        <div id="id-current-departure">Drag the marker change the location</div>
		        <button id="id-save-my-location-departure"> Save my location</button>
		    </section>
    </div>
    <div id="id-baggage-share-tab" class="tab-pane fade active">
      <div id="divAllDemandedUserTickets" class="infinite-container">
		<ul style="list-style-type:none" id="demandedUserTicketList">
			{% for ticket in submitted_tickets %}
			<div class="infinite-item">
				<li id="{{forloop.counter}}">
					<article class="media content-section content-box">
					  <img class="rounded-circle article-img" src="{{ ticket.author.profile.image.url }}">
					  <div class="media-body">
					    <div class="article-metadata content-box">
					      <a class="mr-2" href="#">{{ ticket.author.username }}</a>
					      <small class="text-muted">{{ ticket.date_posted }}</small>
					    </div>
					    <label id="user-departure-airport" class="text-muted"><b>From: </b>{{ ticket.departure_airport }} </label>
					    <label id="user-arrival-airport" class="text-muted"><b>To: </b>{{ ticket.arrival_airport }} </label>
					    <label id="user-flight-number" class="text-muted"><b>Flight no. </b>{{ ticket.flight_number }}</label>
					    <p hidden id="hidden-other-username" class="article-content">{{ ticket.author.username }}</p>
					    <p hidden id="hidden-other-userid">{{ticket.author.id}}</p>			 
					    <p hidden  id="hidden-lat-dep">{{ticket.lat_dep}}</p>   
					    <p hidden  id="hidden-lng-dep">{{ticket.lng_dep}}</p>   
					    <p hidden  id="hidden-lat-arr">{{ticket.lat_arr}}</p>   
					    <p hidden  id="hidden-lng-arr">{{ticket.lng_arr}}</p>   
					    <label id="user-departure-date" class="text-muted"><b>Travel date: </b>{{ ticket.date }}</label>
					    <label id="user-departure-time" class="text-muted"><b>Travel time: </b>{{ ticket.time }}</label>
					    <p id="user-departure-email" class="article-content">Contact the luggage <b>{{ ticket.is_giver }}</b>: {{ticket.author.email}}</p>
					    {% if ticket.is_verified %}
					    		<label style="color:green">verified</label>
					    {% else %}
						    	<label style="color:red" title="{{ticket.author.username}} has not submitted pdf ticket as a proof of travel">not verified</label> 
					    {% endif %}
					    <button id="idStartChatButton-{{forloop.counter}}-{{ticket.author.id}}-{{ticket.author.username}}" class="form-submit-button">Chat Now</button>
					  </div>
					</article>
				</li>
			</div>
			{% endfor %}
			</ul>
	   </div>
    </div>
    <div id="id-cab-from-airport-tab" class="tab-pane fade">
  		    <section>
		        <div id='map-canvas-arrival' style="z-index: 1"></div>
		        <div id="id-current-arrival">Drag the marker change the location</div>
		        <button id="id-save-my-location-arrival"> Save my location</button>
		    </section>
    </div>
  </div>
</div>
	  {% if submitted_tickets.has_next %}
	    <a class="infinite-more-link" href="?page={{ submitted_tickets.next_page_number }}">More</a>
	  {% endif %}

	  <div class="loading" style="display: none;">
	    Loading...
	  </div>
	  <script>
	    var infinite = new Waypoint.Infinite({
	      element: $('.infinite-container')[0],
	      onBeforePageLoad: function () {
	        $('.loading').show();
	      },
	      onAfterPageLoad: function ($items) {
	        $('.loading').hide();
	      }
	    });

	    var all_neighbours_departure = [];
		var all_neighbours_arrival = [];
		$.ajax({
				url: '/get-neighbours/', //ajax call will be made to this url
				type: 'get',
				data:{
					current_ticket_id:{{current_ticket_id}},
					},
				dataType: "json",
				success: function(response){
					all_neighbours_departure = response['all_neighbours_departure'];
					all_neighbours_arrival = response['all_neighbours_arrival'];
					console.log(all_neighbours_departure);
					console.log(all_neighbours_arrival);
				}
		});

	    var changed_my_pickup_lat = 0.1;
		var changed_my_pickup_lng = 0.1;
		var changed_my_drop_lat = 0.1;
		var changed_my_drop_lng = 0.1;
	        // function initMap() {alert("not ok");}
		    var pickup_points = [];

		    if({{my_pickup_lat}} === 0.1){
		    	changed_my_pickup_lat = parseFloat(document.getElementById('hidden-lat-dep').innerText);
		    }
		    else{
		    	changed_my_pickup_lat = parseFloat({{my_pickup_lat}});
		    }

		    if({{my_pickup_lng}} === 0.1){
		    	changed_my_pickup_lng = parseFloat(document.getElementById('hidden-lng-dep').innerText);
		    }
		    else{
		    	changed_my_pickup_lng = parseFloat({{my_pickup_lng}});
		    }
		    console.log(changed_my_pickup_lat, changed_my_pickup_lng);
		    // console.log(drop_airport_lat.innerText);
		    var drop_points = [];

		    if({{my_drop_lat}} === 0.1)
		    {
		    	changed_my_drop_lat = parseFloat(document.getElementById('hidden-lat-arr').innerText);
		    }
		    else{
		    	changed_my_drop_lat = parseFloat({{my_drop_lat}})
		    }
		    if({{my_drop_lng}} === 0.1)
		    {
		    	changed_my_drop_lng = parseFloat(document.getElementById('hidden-lng-arr').innerText);
		    }
		    else{
		    	changed_my_drop_lng = parseFloat({{my_drop_lng}})
		    }

		    console.log(changed_my_drop_lat, changed_my_drop_lng);

		    var mapDeparture = null;
		    var myMarkerDeparture = null;
		    var mapArrival = null;
		    var myMarkerArrival = null;
		    var markers = null;
		    var markerCluster = null;

	    function initMap(){
		    // console.log({{pickup_airport_lat}}, {{pickup_airport_lng}});
		    mapDeparture = new google.maps.Map(document.getElementById('map-canvas-departure'), {
			    zoom: 3,
			    center: new google.maps.LatLng(-31.563910, 147.154312),
			    mapTypeId: google.maps.MapTypeId.ROADMAP
			});

			// myMarkerDeparture = new google.maps.Marker({
			//     position: new google.maps.LatLng(changed_my_pickup_lat, changed_my_drop_lng),
			//     draggable: true
			// });

			// Create an array of alphabetical characters used to label the markers.
			  var labels = 'BACDEFGHIJKLMNOPQRSTUVWXYZ';

			  // Add some markers to the map.
			  // Note: The code uses the JavaScript Array.prototype.map() method to
			  // create an array of markers based on a given "locations" array.
			  // The map() method here has nothing to do with the Google Maps API.
			  markers = locations.map(function(location, i) {
			    return new google.maps.Marker({
			      position: location,
			      label: labels[i % labels.length]
			    });
			  });


		 //    mapArrival = new google.maps.Map(document.getElementById('map-canvas-arrival'), {
			//     zoom: 15,
			//     center: new google.maps.LatLng(changed_my_drop_lat, changed_my_drop_lng),
			//     mapTypeId: google.maps.MapTypeId.ROADMAP
			// });

		    markerCluster = new MarkerClusterer(mapDeparture, markers,
			      {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
			// myMarkerArrival = new google.maps.Marker({
			//     position: new google.maps.LatLng(changed_my_drop_lat, changed_my_drop_lng),
			//     draggable: true
			// });

			// if(navigator.geolocation){
			// 	navigator.geolocation.getCurrentPosition(setCurrentLocationArrival);
			// 	navigator.geolocation.getCurrentPosition(setCurrentLocationDeparture);
			// }
			// else
			// {
			// 	console.log("this browser does not support geolocation");
			// }
		}

		function setCurrentLocationDeparture(position){
			// Add a marker clusterer to manage the markers.
			//console.log("departure ", changed_my_pickup_lat, changed_my_pickup_lng)
			// myMarkerDeparture = new google.maps.Marker({
		 //    position: new google.maps.LatLng(changed_my_pickup_lat, changed_my_pickup_lng),
		 //    draggable: true
			// });

			// google.maps.event.addListener(myMarkerDeparture, 'dragend', function (evt) {
		 //    document.getElementById('id-current-departure').innerHTML = '<p>Marker dropped: Current Lat: ' + evt.latLng.lat().toFixed(3) + ' Current Lng: ' + evt.latLng.lng().toFixed(3) + '</p>';
		 // 		changed_my_pickup_lat = evt.latLng.lat();
		 // 		changed_my_pickup_lng = evt.latLng.lng();
			// });

			// google.maps.event.addListener(myMarkerDeparture, 'dragstart', function (evt) {
			//     document.getElementById('id-current-departure').innerHTML = '<p>Currently dragging marker...</p>';
			// });

			// mapDeparture.setCenter(myMarkerDeparture.position);
			// myMarkerDeparture.setMap(mapDeparture);
		}

		function setCurrentLocationArrival(position){
			//console.log(changed_my_drop_lat, changed_my_drop_lng)
			myMarkerArrival = new google.maps.Marker({
		    // position: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
		    position: new google.maps.LatLng(changed_my_drop_lat, changed_my_drop_lng),
		    draggable: true
			});

			google.maps.event.addListener(myMarkerArrival, 'dragend', function (evt) {
		    document.getElementById('id-current-arrival').innerHTML = '<p>Marker dropped: Current Lat: ' + evt.latLng.lat().toFixed(3) + ' Current Lng: ' + evt.latLng.lng().toFixed(3) + '</p>';
		 		changed_my_drop_lat = evt.latLng.lat();
		 		changed_my_drop_lng = evt.latLng.lng();
			});

			google.maps.event.addListener(myMarkerArrival, 'dragstart', function (evt) {
			    document.getElementById('id-current-arrival').innerHTML = '<p>Currently dragging marker...</p>';
			});

			mapArrival.setCenter(myMarkerArrival.position);
			myMarkerArrival.setMap(mapArrival);
		}

		$('#id-save-my-location-departure').on('click', function(){
				// console.log(drop_airport_lat, drop_airport_lng);
				// console.log("current ticket id: ", {{current_ticket_id}});

			$.ajax({
				url: '/update-location-departure/', //ajax call will be made to this url
				type: 'post',
				data:{
					my_pickup_lat:changed_my_pickup_lat,
					my_pickup_lng:changed_my_pickup_lng,
					current_ticket_id:{{current_ticket_id}},
					// ticket_pdf:$('#ticket-pdf').val()
					csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
				},
	        	enctype: 'multipart/form-data',
				dataType: "json",
				success: function(response){
					console.log(response['html_from_view']);
				}
			});
		});

		$('#id-save-my-location-arrival').on('click', function(){
				// console.log(drop_airport_lat, drop_airport_lng);
				// console.log("current ticket id: ", {{current_ticket_id}});

			$.ajax({
				url: '/update-location-arrival/', //ajax call will be made to this url
				type: 'post',
				data:{
					my_drop_lat:changed_my_drop_lat,
					my_drop_lng:changed_my_drop_lng,
					current_ticket_id:{{current_ticket_id}},
					// ticket_pdf:$('#ticket-pdf').val()
					csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
				},
	        	enctype: 'multipart/form-data',
				dataType: "json",
				success: function(response){
					console.log(response['html_from_view']);
				}
			});
		});


		var locations = [
		  {lat: -31.563910, lng: 147.154312},
		  {lat: -33.718234, lng: 150.363181},
		  {lat: -33.727111, lng: 150.371124},
		  {lat: -33.848588, lng: 151.209834},
		  {lat: -33.851702, lng: 151.216968},
		  {lat: -34.671264, lng: 150.863657},
		  {lat: -35.304724, lng: 148.662905},
		  {lat: -36.817685, lng: 175.699196},
		  {lat: -36.828611, lng: 175.790222},
		  {lat: -37.750000, lng: 145.116667},
		  {lat: -37.759859, lng: 145.128708},
		  {lat: -37.765015, lng: 145.133858},
		  {lat: -37.770104, lng: 145.143299},
		  {lat: -37.773700, lng: 145.145187},
		  {lat: -37.774785, lng: 145.137978},
		  {lat: -37.819616, lng: 144.968119},
		  {lat: -38.330766, lng: 144.695692},
		  {lat: -39.927193, lng: 175.053218},
		  {lat: -41.330162, lng: 174.865694},
		  {lat: -42.734358, lng: 147.439506},
		  {lat: -42.734358, lng: 147.501315},
		  {lat: -42.735258, lng: 147.438000},
		  {lat: -43.999792, lng: 170.463352}
		]
	  </script>
	  <script src="{% static 'tickets_posted/javascript/markercluster.js' %}"></script>
	  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2iSNNGUxqu4e_98fwFbfqNHC3cmr0qYQ&callback=initMap">
    </script>
{% endif %}